# Деплой дашборда на хостинг с Plesk

Инструкция для размещения проекта на обычном (shared) хостинге с панелью Plesk (например, тариф с 2 GB SSD, 5 MySQL, 768 MB RAM, бесплатный SSL).

## Что понадобится

- Доступ в Plesk (логин/пароль).
- Расширение **Node.js** в Plesk (включите в «Расширения» или у хостера).
- Домен, привязанный к хостингу (можно бесплатный из тарифа).

---

## 1. База данных MySQL

1. В Plesk: **«Базы данных»** → **«Добавить базу данных»**.
2. Имя БД, пользователь и пароль — запомните или сохраните.
3. После создания откройте базу и найдите **строку подключения** (Connection string). Обычно вида:
   ```text
   mysql://логин:пароль@localhost:3306/имя_базы
   ```
   Это будет ваша переменная **`DATABASE_URL`** (подставьте реальные логин, пароль и имя базы).

---

## 2. Подготовка проекта к продакшену (локально)

### 2.1. Переключить Prisma на MySQL

На хостинге используется MySQL, локально у вас может оставаться SQLite.

**Вариант А.** Подменить схему для деплоя:

```bash
# В корне проекта (Windows PowerShell)
copy prisma\schema.prisma prisma\schema.sqlite.backup
copy prisma\schema.mysql.prisma prisma\schema.prisma
```

**Вариант Б.** Вручную в `prisma/schema.prisma` заменить блок `datasource` на:

```prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}
```

### 2.2. Переменные окружения для сборки и продакшена

Создайте файл `.env.production` в корне (не коммитьте в git) или запомните значения:

```env
DATABASE_URL="mysql://логин:пароль@localhost:3306/имя_базы"
NEXTAUTH_URL="https://ваш-домен.ru"
NEXTAUTH_SECRET="придумайте-длинную-случайную-строку-32-символа"
```

- **NEXTAUTH_URL** — точный адрес сайта с https (как будет открываться дашборд).
- **NEXTAUTH_SECRET** — любая длинная случайная строка (можно сгенерировать: `openssl rand -base64 32` или онлайн-генератор).

### 2.3. Сборка (рекомендуется локально)

На shared-хостинге с 768 MB RAM сборка Next.js может падать. Лучше собрать проект на своём компьютере и загрузить уже собранное.

```bash
npm ci
set DATABASE_URL=mysql://...
set NEXTAUTH_URL=https://ваш-домен.ru
set NEXTAUTH_SECRET=ваш-секрет
npm run build
```

После сборки в папке `.next/standalone` появятся файлы для запуска. Нужно ещё скопировать статику и `public`:

**Windows (PowerShell):**

```powershell
Copy-Item -Recurse -Force public .next\standalone\
Copy-Item -Recurse -Force .next\static .next\standalone\.next\
```

**Linux/macOS:**

```bash
cp -r public .next/standalone/
cp -r .next/static .next/standalone/.next/
```

---

## 3. Загрузка на хостинг

Через **Файловый менеджер Plesk** или **FTP** создайте папку для приложения (например, `dashboard` в `httpdocs` или в отдельной поддиректории).

Загрузите:

| Что загружать | Куда |
|---------------|------|
| Всё содержимое папки **`.next/standalone`** (включая вложенные `.next` и `public`) | в корень папки приложения (например, `dashboard/`) |
| Папку **`prisma`** (schema.prisma, migrations, seed.cjs) | в ту же папку приложения |
| Файл **`package.json`** | в ту же папку |

Итоговая структура на сервере (пример):

```text
dashboard/
  server.js          ← из .next/standalone
  node_modules/      ← из .next/standalone (уже в сборке)
  .next/
    static/
    ...
  public/
  prisma/
    schema.prisma
    migrations/
    seed.cjs
  package.json
```

То есть в `dashboard/` лежат `server.js`, папки `.next/`, `public/`, `prisma/` и файл `package.json`. Команда запуска в Plesk: **`node server.js`** из этой папки.

---

## 4. Настройка Node.js в Plesk

1. В Plesk: **«Node.js»** (или «Приложения Node.js») → **«Добавить приложение»** / **«Включить поддержку Node.js»** для нужного домена/поддомена.
2. Укажите:
   - **Корень приложения (Document root / Application root):** путь к папке с `server.js` (например, `dashboard` или полный путь к ней).
   - **Режим:** Production.
   - **Команда запуска:**
     ```text
     node server.js
     ```
     Если Plesk запускает из подпапки, может понадобиться: `node .next/standalone/server.js` — смотрите, откуда панель задаёт текущую директорию.
3. В настройках Node.js добавьте **переменные окружения**:
   - `DATABASE_URL` = строка подключения к MySQL из шага 1.
   - `NEXTAUTH_URL` = `https://ваш-домен.ru`.
   - `NEXTAUTH_SECRET` = та же строка, что и при сборке.
   - При необходимости: `NODE_ENV=production`, `PORT=3000` (если Plesk не подставляет порт сам).
4. Сохраните настройки и **перезапустите** Node.js-приложение.

---

## 5. Инициализация базы на сервере

Таблицы в MySQL нужно создать один раз. Варианты:

**Вариант А. Через SSH (если есть доступ):**

```bash
cd /path/to/dashboard
npm install --omit=dev
npx prisma generate
npx prisma db push
```

**Вариант Б. Без SSH:** в Plesk часто есть «Выполнить команду» или скрипт запуска. Укажите ту же последовательность команд из корня приложения. Либо один раз выполните `npx prisma db push` через любой доступный способ (например, временный скрипт в cron или задание в Plesk).

После этого можно при желании выполнить сид (если нужны тестовые данные):

```bash
node prisma/seed.cjs
```

---

## 6. Домен и SSL

1. В Plesk привяжите домен к нужной директории (где настроено Node.js).
2. **«SSL/TLS-сертификаты»** → включите бесплатный сертификат (Let's Encrypt или аналог от хостера).
3. Убедитесь, что в **NEXTAUTH_URL** указан именно https-адрес этого домена.

---

## 7. Проверка

- Откройте в браузере `https://ваш-домен.ru`.
- Должна открыться страница входа. Создайте первого админа через сид или отдельный скрипт, если в seed есть создание пользователя.

---

## Частые проблемы

| Проблема | Что проверить |
|----------|----------------|
| 502 Bad Gateway | Запущено ли Node.js-приложение в Plesk, правильная ли команда `node server.js` и корень приложения. |
| Ошибки БД при входе | Корректен ли `DATABASE_URL`, выполнены ли `prisma generate` и `prisma db push`. |
| «Неверный callback» / ошибки NextAuth | Совпадают ли `NEXTAUTH_URL` (с https) и реальный адрес сайта, задан ли `NEXTAUTH_SECRET`. |
| Мало памяти при сборке на хостинге | Собирайте проект локально (шаг 2.3) и загружайте уже собранный `.next/standalone`. |

После первого успешного деплоя для обновления кода достаточно заново собрать проект локально, загрузить обновлённые файлы из `.next/standalone` (и при изменении схемы — папку `prisma`) и перезапустить Node.js в Plesk.
